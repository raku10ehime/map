<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä»Šæ²»å¸‚ åœ°å›³è¡¨ç¤º</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .controls {
        padding: 10px;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .controls-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .file-input-label {
        background-color: #2196f3;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .file-input-label:hover {
        background-color: #1976d2;
      }

      #fileInput {
        display: none;
      }

      .map-container {
        flex: 2;
        position: relative;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .table-container {
        flex: 1;
        overflow: auto;
        padding: 10px;
        background-color: #f9f9f9;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: left;
      }

      th {
        background-color: #2196f3;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .highlighted-row {
        background-color: #ffeb3b !important;
      }

      .custom-icon {
        background-color: #2196f3;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .info-panel {
        background-color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .popup-content {
        font-size: 14px;
        line-height: 1.4;
      }

      .popup-content strong {
        color: #2c5234;
      }

      tbody tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
      }

      select {
        padding: 5px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <div class="controls-left">
        <div>
          <label for="groupSelect">ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ:</label>
          <select id="groupSelect">
            <option value="all">å…¨ã¦è¡¨ç¤º</option>
          </select>
        </div>
        <div class="info-panel">
          <strong>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:</strong> <span id="dataCount">0</span>ä»¶ |
          <strong>é¸æŠä¸­:</strong> <span id="selectedGroup">å…¨ã¦</span>
        </div>
      </div>

      <div>
        <label for="fileInput" class="file-input-label"
          >ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</label
        >
        <input
          type="file"
          id="fileInput"
          accept=".csv,text/csv,application/vnd.ms-excel"
        />
      </div>
    </div>

    <div class="map-container">
      <div id="map"></div>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>éƒ½é“åºœçœŒ</th>
            <th>å¸‚åŒºç”ºæ‘</th>
            <th>ç•ªå·</th>
            <th>ä½æ‰€</th>
            <th>åå‰</th>
            <th>ç·¯åº¦</th>
            <th>çµŒåº¦</th>
            <th>å‚™è€ƒ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <script>
      const groupColors = [
        "#E53935",
        "#1E88E5",
        "#43A047",
        "#FB8C00",
        "#8E24AA",
        "#6D4C41",
        "#D81B60",
        "#00897B",
      ];

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let map,
        markers = [],
        csvData = [],
        currentGroup = "all";

      // åœ°å›³åˆæœŸåŒ–
      function initMap() {
        map = L.map("map").setView([34.066, 132.997], 14);
        L.tileLayer(
          "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
          {
            attribution: "åœ°ç†é™¢ã‚¿ã‚¤ãƒ«",
            maxZoom: 18,
          }
        ).addTo(map);
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCSVèª­ã¿è¾¼ã¿
      async function loadDefaultCSV() {
        try {
          const csvContent = await window.fs.readFile("ä»Šæ²»å¸‚.csv", {
            encoding: "utf8",
          });
          parseCSV(csvContent);
        } catch (error) {
          console.log("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
        }
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰CSVèª­ã¿è¾¼ã¿
      function loadCSVFromFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => parseCSV(e.target.result);
        reader.onerror = () => alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        reader.readAsText(file, "UTF-8");
      }

      // CSVè§£æ
      function parseCSV(csvContent) {
        Papa.parse(csvContent, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: true,
          complete: (results) => {
            csvData = results.data;
            processData();
            updateGroupSelector();
            displayData();
            updateTable();
          },
          error: (error) => {
            console.error("CSVè§£æã‚¨ãƒ©ãƒ¼:", error);
            alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          },
        });
      }

      // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ç•ªå·åˆ†é›¢ï¼‰
      function processData() {
        csvData.forEach((item) => {
          if (item.number) {
            const parts = String(item.number).split("-");
            item.group = parts[0] || "";
            item.itemNumber = parts[1] || "";
          } else {
            item.group = "";
            item.itemNumber = "";
          }
        });
      }

      // ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°
      function updateGroupSelector() {
        const groups = [...new Set(csvData.map((item) => item.group))]
          .filter((g) => g !== "")
          .sort((a, b) => parseInt(a) - parseInt(b));

        const select = document.getElementById("groupSelect");
        select.innerHTML = '<option value="all">å…¨ã¦è¡¨ç¤º</option>';

        groups.forEach((group) => {
          const option = document.createElement("option");
          option.value = group;
          option.textContent = `ã‚°ãƒ«ãƒ¼ãƒ— ${group}`;
          select.appendChild(option);
        });
      }

      // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
      function displayData() {
        // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const filteredData =
          currentGroup === "all"
            ? csvData
            : csvData.filter((item) => item.group === currentGroup);

        // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
        filteredData.forEach((item, index) => {
          if (item.lat && item.long) {
            const uniqueGroups = [
              ...new Set(filteredData.map((item) => item.group)),
            ];
            const groupColorMap = {};
            uniqueGroups.forEach((g, i) => {
              groupColorMap[g] = groupColors[i % groupColors.length];
            });

            const color =
              currentGroup === "all"
                ? groupColorMap[item.group] || "#607D8B"
                : "#E53935";

            const customIcon = L.divIcon({
              html: `<div class="custom-icon" style="background-color: ${color}">${
                item.itemNumber || index + 1
              }</div>`,
              className: "custom-div-icon",
              iconSize: [36, 36],
              iconAnchor: [18, 18],
              popupAnchor: [0, -18],
            });

            const marker = L.marker([item.lat, item.long], { icon: customIcon })
              .addTo(map)
              .bindPopup(createPopupContent(item));

            marker.on("click", () => highlightTableRow(item.number));
            markers.push(marker);
          }
        });

        // åœ°å›³ç¯„å›²èª¿æ•´
        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }

        // æƒ…å ±æ›´æ–°
        document.getElementById("dataCount").textContent = filteredData.length;
        document.getElementById("selectedGroup").textContent =
          currentGroup === "all" ? "å…¨ã¦" : `ã‚°ãƒ«ãƒ¼ãƒ— ${currentGroup}`;
      }

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ä½œæˆ
      function createPopupContent(item) {
        return `
                <div class="popup-content">
                    <strong>ç•ªå·:</strong> ${item.number || "N/A"}<br>
                    <strong>åå‰:</strong> ${item.name || "N/A"}<br>
                    <strong>ä½æ‰€:</strong> ${item.address || "N/A"}<br>
                    <strong>ç·¯åº¦:</strong> ${item.lat}<br>
                    <strong>çµŒåº¦:</strong> ${item.long}<br>
                    ${item.note ? `<strong>å‚™è€ƒ:</strong> ${item.note}` : ""}
                </div>
            `;
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
      function updateTable() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        const filteredData =
          currentGroup === "all"
            ? csvData
            : csvData.filter((item) => item.group === currentGroup);

        filteredData.forEach((item) => {
          const row = document.createElement("tr");
          row.setAttribute("data-number", item.number);
          row.innerHTML = `
                    <td>${item.prefecture || ""}</td>
                    <td>${item.city || ""}</td>
                    <td>${item.number || ""}</td>
                    <td>${item.address || ""}</td>
                    <td>${item.name || ""}</td>
                    <td>${item.lat || ""}</td>
                    <td>${item.long || ""}</td>
                    <td>${item.note || ""}</td>
                `;

          row.addEventListener("click", () => {
            const marker = markers.find((m) => {
              const markerData = csvData.find(
                (d) =>
                  d.lat === m.getLatLng().lat && d.long === m.getLatLng().lng
              );
              return markerData?.number === item.number;
            });

            if (marker) {
              marker.openPopup();
              map.panTo(marker.getLatLng());
            }
            highlightTableRow(item.number);
          });

          tbody.appendChild(row);
        });
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆ
      function highlightTableRow(number) {
        document
          .querySelectorAll(".highlighted-row")
          .forEach((row) => row.classList.remove("highlighted-row"));

        const row = document.querySelector(`tr[data-number="${number}"]`);
        if (row) {
          row.classList.add("highlighted-row");
          row.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith(".csv") || file.type.includes("csv")) {
            loadCSVFromFile(file);
          } else {
            alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          }
        }
      });

      document.getElementById("groupSelect").addEventListener("change", (e) => {
        currentGroup = e.target.value;
        displayData();
        updateTable();
      });

      // åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", () => {
        initMap();
        loadDefaultCSV();
      });
    </script>
  </body>
</html>
